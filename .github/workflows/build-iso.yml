name: Build Lurin OS ISO

on:
  workflow_dispatch: {}

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build ISO inside privileged Arch container
        run: |
          mkdir -p out
          docker run --rm --privileged \
            -v "${PWD}:/build" \
            -v "${PWD}/out:/root/lurin-iso" \
            -w /build \
            -e OUTPUT="/root/lurin-iso" \
            archlinux:latest \
            bash -lc '
              set -e
              echo "üì¶ Installing dependencies..."
              pacman -Sy --needed --noconfirm archiso imagemagick sox git

              echo "üîß Enabling multilib..."
              sed -i "s/#\\[multilib\\]/[multilib]/" /etc/pacman.conf || true
              sed -i "s|#Include = /etc/pacman.d/mirrorlist|Include = /etc/pacman.d/mirrorlist|" /etc/pacman.conf || true
              pacman -Sy

              echo "üî® Building ISO..."
              cd /build
              chmod +x ./build-iso.sh
              
              # –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º OUTPUT –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
              export OUTPUT="/root/lurin-iso"
              
              ./build-iso.sh
              
              echo "‚úÖ Build finished. Checking output..."
              ls -lah /root/lurin-iso/ || echo "‚ö†Ô∏è  /root/lurin-iso is empty"
              find /root -name "*.iso" 2>/dev/null || echo "‚ö†Ô∏è  No ISO found in /root"
            '

      - name: List output directory
        run: |
          echo "üìÅ Contents of out/ directory:"
          ls -lah out/ || echo "‚ö†Ô∏è  out/ directory is empty or doesn't exist"
          find . -name "*.iso" -type f || echo "‚ö†Ô∏è  No ISO files found in workspace"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: lurin-os-iso
          path: out/*.iso
          if-no-files-found: warn
